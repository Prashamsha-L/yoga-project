<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Surya Namaskar — Results</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f9fafb;
      --card: #ffffff;
      --text: #111827;
      --muted: #6b7280;
      --accent-green: #10b981;
      --accent-red: #ef4444;
      --radius: 12px;
    }
    /* [Previous CSS unchanged - keeping it brief] */
    body { margin: 0; background-color: rgb(203, 246, 203); font-family: 'Inter', sans-serif; color: var(--text); padding: 20px; }
    .container { max-width: 1200px; margin: 0 auto; }
    .card { background: var(--card); border-radius: var(--radius); padding: 18px; border: 1px solid rgba(0,0,0,0.05); margin-bottom: 20px; }
    .summary { display: grid; gap: 12px; }
    .summary .item { display: flex; justify-content: space-between; align-items: center; }
    .progress-bar { height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; margin-bottom: 2px; }
    .progress-fill { height: 100%; border-radius: 3px; }
    .progress-text { font-size: 11px; font-weight: 700; text-align: center; }
    .table-view { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 12px; table-layout: fixed; }
    th, td { padding: 10px 6px; border-right: 1px solid #e5e7eb; border-bottom: 1px solid rgba(0,0,0,0.05); text-align: center; font-size: 15px; }
    th:last-child, td:last-child { border-right: none; }
    th { font-weight: 600; color: var(--muted); font-size: 15px; background: #f8fafc; position: sticky; top: 0; z-index: 10; }
    th:first-child, td:first-child { width: 5%; }
    th:nth-child(2), td:nth-child(2) { width: 22%; text-align: left; }
    th:nth-child(n+3), td:nth-child(n+3) { width: calc(73% / 12); min-width: 50px; }
    .grid-view { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 10px; margin-top: 12px; }
    .grid-pose { background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px 8px; text-align: center; }
    .grid-pose-header { font-size: 15px; color: var(--muted); margin-bottom: 6px; font-weight: 600; line-height: 1.2; }
    .small { font-size: 15px; color: var(--muted); }
    
    /* ✅ NEW SMART CORRECTIONS */
    .suggestion-item {
      margin-bottom: 12px;
      padding: 12px;
      background: #fef2f2;
      border-radius: 8px;
      border-left: 4px solid var(--accent-red);
      position: relative;
    }
    .pose-corrections {
      margin-top: 8px;
      padding: 10px;
      background: #fff5f5;
      border-radius: 6px;
      border-left: 3px solid var(--accent-yellow);
    }
    .correction-list {
      font-size: 18px;
      margin: 4px 0;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }
    .correction-tag {
      background: #fee2e2;
      color: var(--accent-red);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 15px;
      font-weight: 800;
    }
    button { padding: 6px 12px; border: none; border-radius: 6px; background: var(--accent-green); color: #fff; cursor: pointer; font-weight: 600; }
    button:hover { background-color: rgb(11, 112, 25); }
    .view-toggle { margin-bottom: 12px; display: flex; gap: 8px; }
    .view-toggle button { background: var(--accent-green); padding: 4px 12px; font-size: 15px; }
    .view-toggle button.active { background: var(--accent-green); }
    .view-toggle button:hover {
  background-color: rgb(11, 112, 25);
  color: #fff;
}
  </style>
</head>

<body>
<div class="container">
  <header>
    <div>
      <h1>Surya Namaskar Results</h1>
      <div class="meta" id="sessionMeta">Loading...</div>
    </div>
    <div style="display:flex;gap:8px;margin-top: 15px;margin-bottom: 10px;">
      <button onclick="location.href='surya.html'">New Session</button>
      <button onclick="window.print()">Print</button>
      <button onclick="location.href='home.html'">Back to Home</button>
    </div>
  </header>

  <div class="card">
    <h2>Summary</h2>
    <div class="summary" id="summaryCards"></div>
  </div>

  <div class="card">
    <h2>Detailed Analysis</h2>
    <div class="view-toggle">
      <button id="tableBtn" class="active" onclick="switchView('table')">Table</button>
      <button id="gridBtn" onclick="switchView('grid')">Grid</button>
    </div>
    <div id="tableContainer" class="table-view">
      <table>
        <thead>
          <tr id="roundHeaderRow">
            <th>Pose number</th>
            <th>Pose name</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div id="gridContainer" class="grid-view" style="display:none"></div>
  </div>

  <div class="card">
    <h2>Smart Corrections (<span id="suggestionCount">0</span>)</h2>
    <div id="correctionsList"></div>
  </div>
</div>

<script>
  window.suryaPoses = [
    "Pranamasana", "Hasta Uttanasana", "Padahastasana",
    "Ashwa Sanchalanasana", "Chaturanga Dandasana", "Ashtanga Namaskar",
    "Bhujangasana", "Adho Mukha Svanasana", "Ashwa Sanchalanasana",
    "Padahastasana", "Hasta Uttanasana", "Pranamasana"
  ];

  const poseCorrections = {
    "Pranamasana": ["Keep hands together at chest", "Stand straight and relaxed", "Keep shoulders down and breathing calm"],
    "Hasta Uttanasana": [
      "Arms straight overhead", 
      "Arch from upper back", 
      "Gaze up gently"
    ],
    "Padahastasana": [
      "Fold forward from the hips","Let the head move toward the knees","Keep knees slightly bent if needed"
    ],
    "Ashwa Sanchalanasana": [
      "Step one leg back comfortably","Keep the front knee over the ankle","Lift the chest and look forward"
    ],
    "Chaturanga Dandasana": [
      "Lower the body in a straight line","Keep elbows close to the ribs"
,"Engage the core for support","Body plank straight",  
    ],
    "Ashtanga Namaskar": [
      "Bring knees, chest, and chin to the floor","Keep hips slightly raised","Relax into the posture"
    ],
    "Bhujangasana": ["Press palms gently into the mat",
      "Lift chest only", 
      "Elbows bent slightly", 
      "Shoulders down", 
  
    ],
    "Adho Mukha Svanasana": [
      "Place hands firmly and lift hips upward","Keep spine long and stretch the back","Press heels down and breathe deeply"
    ]
  };

  const data = JSON.parse(localStorage.getItem('suryaSessionFull') || '{}');
  let currentView = 'table';

  function createProgressBar(acc) {
    if (acc === 0) return '<span class="small">–</span>';
    const color = acc >= 65 ? 'var(--accent-green)' : 'var(--accent-red)';
    return `
      <div class="progress-bar">
        <div class="progress-fill" style="width: ${acc}%; background: ${color};"></div>
      </div>
      <div class="progress-text" style="color: ${color}">${acc}%</div>
    `;
  }

  function getPoseCorrections(poseName, accuracy) {
    if (accuracy >= 65 || !poseCorrections[poseName]) return [];
    return poseCorrections[poseName] || [];
  }

  function switchView(view) {
    currentView = view;
    document.getElementById('tableContainer').style.display = view === 'table' ? 'block' : 'none';
    document.getElementById('gridContainer').style.display = view === 'grid' ? 'grid' : 'none';
    document.getElementById('tableBtn').classList.toggle('active', view === 'table');
    document.getElementById('gridBtn').classList.toggle('active', view === 'grid');
  }

  if (!data.steps || data.steps.length === 0) {
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="14" class="small">No session data found.</td></tr>';
    document.getElementById('sessionMeta').textContent = 'No data';
    document.getElementById('correctionsList').innerHTML = '<p class="small">No suggestions available.</p>';
  } else {
    const steps = data.steps;
    const rounds = data.rounds || 1;
    const numPoses = window.suryaPoses.length;

    document.getElementById('sessionMeta').textContent = `Completed: ${data.sessionDate} | Rounds: ${rounds}`;

    // Group data by pose and round
    const poseGroups = Array(numPoses).fill().map(() => ({}));
    steps.forEach(step => {
      const idx = step.index - 1;
      if (idx >= 0 && idx < numPoses) {
        poseGroups[idx][step.round] = step;
      }
    });

    // Stats
    const performed = steps.filter(s => s.accuracy > 0);
    const noPosePerformed = performed.length === 0;

    const overall = performed.length ? Math.round(performed.reduce((sum, s) => sum + s.accuracy, 0) / performed.length) : 0;

    // Summary
    document.getElementById('summaryCards').innerHTML = `
      <div class="item"><div class="small">Overall Accuracy</div><div style="font-weight:700">${overall}%</div></div>
      <div class="item"><div class="small">Poses Performed</div><div style="font-weight:700">${performed.length}/${steps.length}</div></div>
      <div class="item"><div class="small">Total Rounds</div><div style="font-weight:700">${rounds}</div></div>
    `;

    // ✅ FIXED TABLE HEADERS
    const headerRow = document.getElementById('roundHeaderRow');
    const maxRoundsToShow = Math.min(rounds, 12);
    while (headerRow.children.length > 2) {
      headerRow.removeChild(headerRow.lastChild);
    }
    for (let i = 1; i <= maxRoundsToShow; i++) {
      const th = document.createElement('th');
      th.textContent = `R${i}`;
      headerRow.appendChild(th);
    }

    // Table body
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = window.suryaPoses.map((poseName, idx) => {
      const cells = [];
      for (let r = 1; r <= maxRoundsToShow; r++) {
        const step = poseGroups[idx][r];
        cells.push(`<td>${createProgressBar(step ? step.accuracy : 0)}</td>`);
      }
      return `<tr><td>${idx+1}</td><td style="text-align:left">${poseName}</td>${cells.join('')}</tr>`;
    }).join('');

    // Grid view
    const gridContainer = document.getElementById('gridContainer');
    const gridHtml = [];
    window.suryaPoses.forEach((poseName, idx) => {
      for (let r = 1; r <= rounds; r++) {
        const step = poseGroups[idx][r];
        const acc = step ? step.accuracy : 0;
        gridHtml.push(`
          <div class="grid-pose">
            <div class="grid-pose-header">${poseName}<br><small>R${r}</small></div>
            ${createProgressBar(acc)}
          </div>
        `);
      }
    });
    gridContainer.innerHTML = gridHtml.join('');

    
    const poorPoses = {};
    steps.forEach(step => {
      if (step.accuracy > 0 && step.accuracy < 55) {
        const poseIdx = step.index - 1;
        const poseName = window.suryaPoses[poseIdx];
        if (!poorPoses[poseName]) poorPoses[poseName] = [];
        poorPoses[poseName].push(step);
      }
    });

    const correctionsList = document.getElementById('correctionsList');
    let suggestionsHtml = '';
    if (noPosePerformed) {correctionsList.innerHTML = `<p class="small" style="color:var(--muted)">
      No poses were performed in this session.</p>`;
  document.getElementById('suggestionCount').textContent = 0;
}
    else if (Object.keys(poorPoses).length === 0) {
      suggestionsHtml = '<p class="small" style="color:greeen;font-size:16px;"">All performed poses are correct! Great job! </p>';
    } else {
      // Show recent rounds first (last 20 rounds max)
      const recentSteps = steps.filter(s => s.round > Math.max(0, rounds - 20) && s.accuracy > 0 && s.accuracy < 55);
      
      suggestionsHtml = `<p class="small">Recent corrections (${recentSteps.length})</p>`;
      
      Object.keys(poorPoses).forEach(poseName => {
        const instances = poorPoses[poseName].slice(-5); // Last 5 attempts max
        const corrections = getPoseCorrections(poseName, instances[0]?.accuracy);
        
        suggestionsHtml += `
          <div class="suggestion-item">
            <strong>${poseName}</strong> 
            <div style="color:var(--accent-red);font-weight:600">${Math.round(instances.reduce((sum, s) => sum + s.accuracy, 0) / instances.length)}% avg</div>
            
            ${corrections.length > 0 ? `
              <div class="pose-corrections">
                <div style="font-size:15px;color:var(--accent-yellow);margin-bottom:4px">Focus on:</div>
                <div class="correction-list">
                  ${corrections.map(c => `<span class="correction-tag">${c}</span>`).join('')}
                </div>
              </div>
            ` : ''}
            
            <div style="font-size:15px;color:var(--muted);margin-top:6px">
              Rounds: ${instances.map(s => s.round).join(', ')}
            </div>
          </div>
        `;
      });
    }

    correctionsList.innerHTML = suggestionsHtml;
    document.getElementById('suggestionCount').textContent = Object.keys(poorPoses).length;
  }
</script>
</body>
</html>